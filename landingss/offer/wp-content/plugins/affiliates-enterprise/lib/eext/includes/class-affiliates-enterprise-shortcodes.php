<?php
 if ( !defined( 'ABSPATH' ) ) { exit; } class Affiliates_Enterprise_Shortcodes { public static function init() { add_shortcode( 'affiliates_tiers', array( __CLASS__, 'affiliates_tiers' ) ); add_shortcode( 'affiliates_campaigns', array( __CLASS__, 'affiliates_campaigns' ) ); add_shortcode( 'affiliates_manage_campaigns', array( __CLASS__, 'affiliates_manage_campaigns' ) ); add_shortcode( 'affiliates_pixel', array( __CLASS__, 'affiliates_pixel' ) ); } public static function affiliates_tiers( $IXAP220, $IXAP167 = null ) { $IXAP105 = shortcode_atts( array( 'link_to_user_url' => 'no', 'show_depth_title' => 'no', 'depth_title' => __( 'Depth %d', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_avatar' => 'yes', 'avatar_size' => 32, 'style' => '<style type="text/css">.branch {padding-left:1em;margin-right:1em;} .branch img.avatar {vertical-align:middle;padding:4px;}</style>', 'max_depth' => null, 'show_from_date' => 'no', 'show_thru_date' => 'no', 'since' => __( 'since %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'until' => __( 'until %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_email' => 'no', 'before_referrals' => '', 'after_referrals' => '', 'closed' => 'yes', 'accepted' => 'yes', 'pending' => 'no', 'rejected' => 'no' ), $IXAP220 ); $IXAP446 = $IXAP105['max_depth']; if ( $IXAP446 !== null ) { $IXAP446 = intval( $IXAP446 ); if ( $IXAP446 <= 0 ) { $IXAP446 = null; } } $IXAP105['max_depth'] = $IXAP446; $IXAP105['link_to_user_url'] = $IXAP105['link_to_user_url'] === 'yes'; $IXAP105['show_depth_title'] = $IXAP105['show_depth_title'] === 'yes'; $IXAP105['show_avatar'] = $IXAP105['show_avatar'] === 'yes'; $IXAP105['show_from_date'] = $IXAP105['show_from_date'] === 'yes'; $IXAP105['show_thru_date'] = $IXAP105['show_thru_date'] === 'yes'; $IXAP105['show_email'] = $IXAP105['show_email'] === 'yes'; $IXAP105['accepted'] = $IXAP105['accepted'] === 'yes'; $IXAP105['closed'] = $IXAP105['closed'] === 'yes'; $IXAP105['pending'] = $IXAP105['pending'] === 'yes'; $IXAP105['rejected'] = $IXAP105['rejected'] === 'yes'; $IXAP62 = ''; if ( $IXAP9 = get_current_user_id() ) { if ( $IXAP252 = affiliates_get_user_affiliate( $IXAP9 ) ) { if ( count( $IXAP252 ) > 0 ) { Affiliates_Multi_Tier::get_tree( $IXAP252, $IXAP505 ); self::render_tree( $IXAP252, $IXAP505, $IXAP62, $IXAP446, 0, $IXAP105 ); } } } $IXAP62 = apply_filters( 'affiliates_tiers_output', $IXAP62 ); return $IXAP62; } public static function render_tree( $IXAP549, &$IXAP505, &$IXAP62, $IXAP446 = null, $IXAP509 = 0, $IXAP105 = array() ) { global $affiliates_db; $IXAP49 = $affiliates_db->get_tablename( 'referrals' ); $IXAP105 = shortcode_atts( array( 'link_to_user_url' => false, 'show_depth_title' => false, 'depth_title' => __( 'Depth %d', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_avatar' => true, 'avatar_size' => 32, 'style' => '.branch {padding-left:1em;margin-right:1em;} .branch img.avatar {vertical-align:middle;padding:4px;}', 'show_from_date' => false, 'show_thru_date' => false, 'since' => __( 'since %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'until' => __( 'until %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_email' => false, 'before_referrals' => '', 'after_referrals' => '', 'accepted' => true, 'closed' => true, 'pending' => false, 'rejected' => false ), $IXAP105 ); $IXAP196 = array(); if ( $IXAP105['accepted'] ) { $IXAP196[] = "'" . AFFILIATES_REFERRAL_STATUS_ACCEPTED . "'"; } if ( $IXAP105['closed'] ) { $IXAP196[] = "'" . AFFILIATES_REFERRAL_STATUS_CLOSED . "'"; } if ( $IXAP105['pending'] ) { $IXAP196[] = "'" . AFFILIATES_REFERRAL_STATUS_PENDING . "'"; } if ( $IXAP105['rejected'] ) { $IXAP196[] = "'" . AFFILIATES_REFERRAL_STATUS_REJECTED . "'"; } if ( count( $IXAP196 ) > 0 ) { $IXAP196 = implode( ',', $IXAP196 ); } else { return; } if ( !empty( $IXAP105['style'] ) ) { $IXAP62 .= '<style type="text/css">'; $IXAP62 .= $IXAP105['style']; $IXAP62 .= '</style>'; } $IXAP62 .= sprintf( '<div class="depth depth-%d %s">', $IXAP509, $IXAP509 % 2 ? 'odd' : 'even' ); if ( $IXAP105['show_depth_title'] && $IXAP509 > 0 ) { $IXAP62 .= '<span class="title">'; $IXAP62 .= sprintf( $IXAP105['depth_title'], $IXAP509 ); $IXAP62 .= '</span>'; } $IXAP62 .= '<ul class="branch">'; foreach( $IXAP505 as $IXAP24 => $IXAP510 ) { $IXAP62 .= '<li>'; $IXAP361 = affiliates_get_affiliate( $IXAP24 ); if ( $IXAP361 ) { $IXAP9 = affiliates_get_affiliate_user( $IXAP24 ); $IXAP62 .= '<div class="affiliate">'; if ( $IXAP105['show_avatar'] ) { $IXAP550 = ''; $IXAP551 = intval( $IXAP105['avatar_size'] ); if ( $IXAP9 ) { $IXAP550 = get_avatar( $IXAP9, $IXAP551 ); } else if ( !empty( $IXAP361['email'] ) ) { $IXAP550 = get_avatar( $IXAP361['email'], $IXAP551 ); } $IXAP62 .= $IXAP550; } if ( $IXAP105['link_to_user_url'] && ( $IXAP95 = get_user_by( 'id', $IXAP9 ) ) && !empty( $IXAP95->user_url ) ) { $IXAP62 .= sprintf( '<a href="%s" title="%s">%s</a>', esc_attr( $IXAP95->user_url ), sprintf( __( 'Visit %s\'s website', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), wp_filter_nohtml_kses( $IXAP361['name'] ) ), wp_filter_nohtml_kses( $IXAP361['name'] ) ); } else { $IXAP62 .= wp_filter_nohtml_kses( $IXAP361['name'] ); } $IXAP62 .= '</div>'; if ( $IXAP105['show_email'] && !empty( $IXAP361['email'] ) ) { $IXAP62 .= '<div class="email">'; $IXAP62 .= sprintf( '<a href="mailto:%s">', esc_attr( $IXAP361['email'] ) ); $IXAP62 .= wp_strip_all_tags( $IXAP361['email'] ); $IXAP62 .= '</a>'; $IXAP62 .= '</div>'; } if ( $IXAP105['show_from_date'] ) { $IXAP62 .= '<div class="from_date">'; $IXAP62 .= sprintf( $IXAP105['since'], date_i18n( get_option( 'date_format' ), strtotime( $IXAP361['from_date'] ) ) ); $IXAP62 .= '</div>'; } if ( $IXAP105['show_thru_date'] ) { if ( $IXAP361['thru_date'] ) { $IXAP62 .= '<div class="thru_date">'; $IXAP62 .= sprintf( $IXAP105['until'], date_i18n( get_option( 'date_format' ), strtotime( $IXAP361['thru_date'] ) ) ); $IXAP62 .= '</div>'; } } if ( count( $IXAP549 ) === 1 ) { $IXAP552 = "SELECT sum(amount) total, currency_id FROM $IXAP49 " . "WHERE affiliate_id = %d " . "AND status IN ($IXAP196) " . "AND IFNULL(reference,post_id) IN " . "(SELECT IFNULL(reference,post_id) FROM $IXAP49 WHERE affiliate_id = %d) " . "AND data LIKE '%%tier_level%%\"value\";i:%d%%' " . "GROUP BY currency_id"; $IXAP553 = $affiliates_db->get_objects( $IXAP552, intval( $IXAP549[0] ), intval( $IXAP24 ), intval( $IXAP509 ) ); if ( count( $IXAP553 ) > 0 ) { $IXAP62 .= '<div class="referrals">'; $IXAP62 .= stripslashes( wp_filter_kses( $IXAP105['before_referrals'] ) ); $IXAP62 .= '<ul>'; foreach( $IXAP553 as $IXAP554 ) { $IXAP62 .= '<li>' . sprintf( __( '%s %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), $IXAP554->total, $IXAP554->currency_id ) . '</li>'; } $IXAP62 .= '</ul>'; $IXAP62 .= stripslashes( wp_filter_kses( $IXAP105['after_referrals'] ) ); $IXAP62 .= '</div>'; } } } if ( !empty( $IXAP510 ) ) { if ( $IXAP446 === null || $IXAP446 > 0 ) { if ( $IXAP509 === 0 ) { $IXAP555 = array( $IXAP24 ); } else { $IXAP555 = $IXAP549; } self::render_tree( $IXAP555, $IXAP510, $IXAP62, $IXAP446 === null ? null : $IXAP446 - 1, $IXAP509 + 1, $IXAP105 ); } } $IXAP62 .= '</li>'; } $IXAP62 .= '</ul>'; $IXAP62 .= '</div>'; } public static function affiliates_campaigns( $IXAP220, $IXAP167 = null ) { $IXAP105 = shortcode_atts( array( 'style' => '<style type="text/css">.branch {padding-left:1em;margin-right:1em;}</style>', 'show_from_date' => 'no', 'show_thru_date' => 'no', 'since' => __( 'since %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'until' => __( 'until %s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'show_email' => 'no', 'closed' => 'yes', 'accepted' => 'yes', 'pending' => 'no', 'rejected' => 'no' ), $IXAP220 ); $IXAP105['show_from_date'] = $IXAP105['show_from_date'] === 'yes'; $IXAP105['show_thru_date'] = $IXAP105['show_thru_date'] === 'yes'; $IXAP105['accepted'] = $IXAP105['accepted'] === 'yes'; $IXAP105['closed'] = $IXAP105['closed'] === 'yes'; $IXAP105['pending'] = $IXAP105['pending'] === 'yes'; $IXAP105['rejected'] = $IXAP105['rejected'] === 'yes'; $IXAP62 = ''; if ( $IXAP9 = get_current_user_id() ) { if ( $IXAP252 = affiliates_get_user_affiliate( $IXAP9 ) ) { if ( $IXAP24 = array_shift( $IXAP252 ) ) { $IXAP529 = Affiliates_Campaign::get_campaigns( $IXAP24 ); if ( count( $IXAP529 ) > 0 ) { $IXAP62 .= '<div class="affiliates-campaigns">'; $IXAP62 .= '<table>'; $IXAP62 .= '<thead>'; $IXAP62 .= '<tr>'; $IXAP62 .= '<th>' . __( 'ID', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP62 .= '<th>' . __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP62 .= '<th>' . __( 'Hits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP62 .= '<th>' . __( 'Visits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP62 .= '<th>' . __( 'Referrals', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP62 .= '<th>' . __( 'Total', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) . '</th>'; $IXAP62 .= '</tr>'; $IXAP62 .= '</thead>'; $IXAP62 .= '<tbody>'; foreach( $IXAP529 as $IXAP530 ) { $IXAP62 .= '<tr>'; $IXAP520 = ''; $IXAP245 = $IXAP530->totals; if ( !empty( $IXAP245) ) { $IXAP521 = count( $IXAP245 ) > 1; $IXAP520 .= $IXAP521 ? '<ul>' : ''; foreach( $IXAP245 as $IXAP292 => $IXAP28 ) { $IXAP520 .= $IXAP521 ? '<li>' : ''; $IXAP520 .= sprintf( __( '%1$s %2$s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), $IXAP292, $IXAP28 ); $IXAP520 .= $IXAP521 ? '</li>' : ''; } $IXAP520 .= $IXAP521 ? '</ul>' : ''; } $IXAP62 .= sprintf( '<td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td>', $IXAP530->campaign_id, stripslashes( $IXAP530->name ), $IXAP530->hits, $IXAP530->visits, $IXAP530->referrals, $IXAP520 ); $IXAP62 .= '</tr>'; } $IXAP62 .= '</tbody>'; $IXAP62 .= '</table>'; $IXAP62 .= '</div>'; } else { $IXAP62 .= '<div class="affiliates-campaigns no-campaigns">'; $IXAP62 .= __( 'There are no campaigns.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); $IXAP62 .= '</div>'; } } } } $IXAP62 = apply_filters( 'affiliates_campaigns_output', $IXAP62 ); return $IXAP62; } public static function affiliates_manage_campaigns( $IXAP220, $IXAP167 = null ) { $IXAP62 = ''; if ( $IXAP9 = get_current_user_id() ) { if ( $IXAP252 = affiliates_get_user_affiliate( $IXAP9 ) ) { if ( $IXAP24 = array_shift( $IXAP252 ) ) { ob_start(); Affiliates_Campaign_Table::render( array( 'affiliate_id' => $IXAP24 ) ); return ob_get_clean(); } } } $IXAP62 = apply_filters( 'affiliates_manage_campaigns_output', $IXAP62 ); return $IXAP62; } public static function affiliates_pixel( $IXAP220, $IXAP167 = null ) { $IXAP220 = shortcode_atts( array( 'type' => 'image' ), $IXAP220 ); $IXAP62 = ''; if ( $IXAP9 = get_current_user_id() ) { if ( $IXAP252 = affiliates_get_user_affiliate( $IXAP9 ) ) { if ( $IXAP24 = array_shift( $IXAP252 ) ) { $IXAP147 = get_option( 'aff_pname', AFFILIATES_PNAME ); $IXAP556 = new Affiliates_Pixel( home_url(), $IXAP147 ); $IXAP557 = true; $IXAP461 = get_headers( $IXAP556->get_pixel_url() ); foreach( $IXAP461 as $IXAP558 ) { if ( stripos( $IXAP558, '200 OK' ) !== false ) { $IXAP557 = false; break; } } $IXAP556->parametric = $IXAP557; $IXAP163 = Affiliates_Url_Renderer::get_affiliate_url( $IXAP556->get_pixel_url(), $IXAP24 ); switch( $IXAP220['type'] ) { case 'img' : case 'image' : $IXAP62 .= sprintf( '&lt;img src="%s" alt="" width="1" height="1" /&gt;', esc_url( $IXAP163 ) ); break; default : $IXAP62 .= sprintf( '&lt;iframe src="%s" scrolling="no" frameborder="0" width="1" height="1"&gt;&lt;/iframe&gt;', esc_url( $IXAP163 ) ); } } } } $IXAP62 = apply_filters( 'affiliates_pixel', $IXAP62, $IXAP220 ); return $IXAP62; } } Affiliates_Enterprise_Shortcodes::init(); 