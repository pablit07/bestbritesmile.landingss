<?php
 if ( !defined( 'ABSPATH' ) ) { exit; } if ( !class_exists( 'WP_Screen' ) ) { require_once ABSPATH . 'wp-admin/includes/screen.php'; } if ( !function_exists( 'convert_to_screen' ) ) { require_once ABSPATH . 'wp-admin/includes/template.php'; } if( !class_exists( 'WP_List_Table' ) ){ require_once ABSPATH . 'wp-admin/includes/class-wp-list-table.php'; } class Affiliates_Campaign_Table extends WP_List_Table { private $affiliate_id = null; const IXAP518 = 5000; function __construct( $args = array() ){ global $IXAP247, $IXAP20; if ( isset( $args['affiliate_id'] ) ) { $this->affiliate_id = $args['affiliate_id']; } parent::__construct( array( 'singular' => 'campaign', 'plural' => 'campaigns', 'ajax' => false, 'screen' => 'manage-campaigns' ) ); if ( !is_admin() ) { wp_enqueue_script( 'affiliates-campaigns' ); } wp_enqueue_style( 'affiliates-campaigns' ); } function column_default( $IXAP519, $IXAP388 ){ $IXAP15 = ''; switch( $IXAP388 ) { case 'affiliate_id' : if ( $IXAP361 = affiliates_get_affiliate( $IXAP519[$IXAP388] ) ) { $IXAP15 = stripslashes( wp_filter_nohtml_kses( $IXAP361['name'] ) ); } break; case 'campaign_id' : case 'name' : case 'description' : case 'from_date' : case 'thru_date' : case 'type' : case 'status' : case 'hits' : case 'visits' : case 'referrals' : $IXAP15 = stripslashes( $IXAP519[$IXAP388] ); break; case 'totals' : $IXAP520 = ''; $IXAP245 = $IXAP519['totals']; if ( !empty( $IXAP245) ) { $IXAP521 = count( $IXAP245 ) > 1; $IXAP520 .= $IXAP521 ? '<ul>' : ''; foreach( $IXAP245 as $IXAP292 => $IXAP28 ) { $IXAP520 .= $IXAP521 ? '<li>' : ''; $IXAP520 .= sprintf( __( '%1$s %2$s', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), $IXAP292, $IXAP28 ); $IXAP520 .= $IXAP521 ? '</li>' : ''; } $IXAP520 .= $IXAP521 ? '</ul>' : ''; } $IXAP15 = $IXAP520; break; case 'url' : $IXAP163 = $IXAP519['campaign']->get_url(); $IXAP15 = htmlentities( $IXAP163 ); break; case 'actions' : $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'campaign_id', $IXAP70 ); $IXAP70 = remove_query_arg( 'action', $IXAP70 ); printf( "<a class='button action' title='%s' href='%s'>%s</a>", esc_attr( __( 'Edit this campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ), esc_url( wp_nonce_url( add_query_arg( array( 'campaign_id' => $IXAP519['campaign_id'], 'action' => 'edit-campaign' ), $IXAP70 ) ) ), __( 'Edit', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); break; default : if ( is_string( $IXAP519[$IXAP388] ) ) { $IXAP15 = wp_strip_all_tags( $IXAP519[$IXAP388] ); } } return $IXAP15; } function column_cb( $IXAP519 ){ $IXAP522 = ''; $IXAP523 = new Affiliates_Campaign(); if ( $IXAP523->read( $IXAP519['campaign_id'] ) ) { if ( $IXAP523->hits || $IXAP523->referrals ) { $IXAP522 = ' disabled="disabled" '; } } return sprintf( '<input class="campaign-cb" type="checkbox" name="_campaign_id[]" value="%d" %s />', intval( $IXAP519['campaign_id'] ), $IXAP522 ); } function get_columns(){ $IXAP258 = array( 'cb' => '<input type="checkbox" />', 'campaign_id' => __( 'ID', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'affiliate_id' => __( 'Affiliate', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'name' => __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'description' => __( 'Description', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'hits' => __( 'Hits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'visits' => __( 'Visits', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'referrals' => __( 'Referrals', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'totals' => __( 'Totals', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'url' => __( 'URL', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ), 'actions' => '' ); if ( isset( $this->affiliate_id ) ) { unset( $IXAP258['affiliate_id'] ); } return $IXAP258; } function get_sortable_columns() { $IXAP524 = array( 'campaign_id' => array( 'campaign_id', false ), 'affiliate_id' => array( 'affiliate_id', false ), 'name' => array( 'name', false ), 'description' => array( 'description', false ) ); if ( isset( $this->affiliate_id ) ) { unset( $IXAP524['affiliate_id'] ); } return $IXAP524; } function get_bulk_actions() { $actions = array( 'delete' => __( 'Delete', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); return $actions; } function process_bulk_action() { $action = $this->current_action(); switch( $action ) { case 'delete' : if ( !empty( $_REQUEST['_campaign_id'] ) ) { $IXAP525 = $_REQUEST['_campaign_id']; $IXAP24 = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( is_array( $IXAP525 ) ) { foreach( $IXAP525 as $IXAP164 ) { if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || Affiliates_Campaign::is_affiliate_campaign( $IXAP24, $IXAP164 ) ) { $IXAP523 = new Affiliates_Campaign(); if ( $IXAP523->read( $IXAP164 ) ) { if ( $IXAP523->hits || $IXAP523->referrals ) { } else { $IXAP523->delete(); } } } } } } break; } } function prepare_items() { global $wpdb; $IXAP526 = 10; $IXAP258 = $this->get_columns(); $IXAP527 = array(); $IXAP528 = $this->get_sortable_columns(); $this->_column_headers = array ($IXAP258, $IXAP527, $IXAP528 ); $this->process_bulk_action(); $IXAP529 = Affiliates_Campaign::get_campaigns( $this->affiliate_id ); $IXAP212 = array(); $IXAP80 = 0; foreach( $IXAP529 as $IXAP530 ) { $IXAP212[] = $IXAP530->to_array(); $IXAP212[$IXAP80]['campaign'] = $IXAP530; $IXAP80++; } if ( !empty( $IXAP212 ) ) { usort( $IXAP212, array( __CLASS__, 'sort' ) ); } $IXAP531 = $this->get_pagenum(); $IXAP532 = count( $IXAP212 ); $IXAP212 = array_slice( $IXAP212, ( ( $IXAP531 - 1 ) * $IXAP526 ), $IXAP526 ); $this->items = $IXAP212; $this->set_pagination_args( array( 'total_items' => $IXAP532, 'per_page' => $IXAP526, 'total_pages' => ceil( $IXAP532 / $IXAP526 ) ) ); } public static function sort( $IXAP533, $IXAP534 ) { $IXAP45 = !empty( $_REQUEST['orderby'] ) ? $_REQUEST['orderby'] : 'campaign_id'; $IXAP46 = strtolower( !empty($_REQUEST['order'] ) ? $_REQUEST['order'] : 'asc' ); if ( $IXAP45 == 'campaign_id' ) { $IXAP15 = $IXAP533[$IXAP45] - $IXAP534[$IXAP45]; } else if ( $IXAP45 == 'affiliate_id' ) { $IXAP535 = affiliates_get_affiliate($IXAP533[$IXAP45]); $IXAP536 = affiliates_get_affiliate($IXAP534[$IXAP45]); $IXAP15 = strcmp( $IXAP535['name'], $IXAP536['name'] ); } else { $IXAP15 = strcmp( $IXAP533[$IXAP45], $IXAP534[$IXAP45] ); } return ( $IXAP46 === 'asc') ? $IXAP15 : -$IXAP15; } public static function render( $IXAP105 = array() ) { $action_executed = false; if ( isset( $_REQUEST['campaign-action'] ) || isset( $_REQUEST['campaign-action'] ) ) { if ( wp_verify_nonce($_REQUEST['_wpnonce'] ) ) { if ( isset( $_REQUEST['action'] ) ) { switch( $_REQUEST['action'] ) { case 'create-campaign' : $IXAP24 = !empty( $_REQUEST['affiliate_id'] ) ? intval( $_REQUEST['affiliate_id'] ) : null; if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( ( $IXAP24 !== null ) && ( $IXAP24 == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) ) ) { $name = !empty( $_REQUEST['campaign_name'] ) ? wp_strip_all_tags( trim( $_REQUEST['campaign_name'] ) ) : ''; $IXAP246 = !empty( $_REQUEST['campaign_description'] ) ? substr( wp_strip_all_tags( trim( $_REQUEST['campaign_description'] ) ), 0, self::IXAP518 ) : ''; $IXAP523 = new Affiliates_Campaign( (object) array( 'affiliate_id' => $IXAP24, 'name' => $name, 'description' => $IXAP246 ) ); if ( $IXAP523->create() ) { $action_executed = true; echo '<div class="updated">'; echo __( 'Campaign created.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } else { echo '<div class="error">'; echo __( 'Campaign could not be created.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } } else { wp_die( __( 'Access denied.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } break; case 'edit-campaign' : $IXAP24 = !empty( $_REQUEST['affiliate_id'] ) ? intval( $_REQUEST['affiliate_id'] ) : null; $IXAP164 = !empty( $_REQUEST['campaign_id'] ) ? intval( $_REQUEST['campaign_id'] ) : null; if ( !empty( $IXAP164 ) ) { $IXAP523 = new Affiliates_Campaign(); if ( $IXAP523->read( $IXAP164 ) ) { if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( ( $IXAP24 !== null ) && ( $IXAP24 == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) && Affiliates_Campaign::is_affiliate_campaign( $IXAP24, $IXAP164 ) ) ) { $name = !empty( $_REQUEST['campaign_name'] ) ? wp_strip_all_tags( trim( $_REQUEST['campaign_name'] ) ) : ''; $IXAP246 = !empty( $_REQUEST['campaign_description'] ) ? substr( wp_strip_all_tags( trim( $_REQUEST['campaign_description'] ) ), 0, self::IXAP518 ) : ''; $IXAP523->name = $name; $IXAP523->description = $IXAP246; if ( $IXAP523->update() ) { $action_executed = true; echo '<div class="updated">'; echo __( 'Campaign updated.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } else { echo '<div class="error">'; echo __( 'Campaign could not be updated.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</div>'; } } else { wp_die( __( 'Access denied.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } } } break; } } } } $IXAP24 = isset( $IXAP105['affiliate_id'] ) ? intval( $IXAP105['affiliate_id'] ) : null; $IXAP537 = false; $IXAP538 = false; if ( !$action_executed ) { if ( isset( $_REQUEST['action'] ) && isset( $_REQUEST['_wpnonce'] ) && wp_verify_nonce( $_REQUEST['_wpnonce'] ) ) { $IXAP164 = isset( $_REQUEST['campaign_id'] ) ? intval( $_REQUEST['campaign_id'] ) : null; switch( $_REQUEST['action'] ) { case 'create-campaign' : $IXAP537 = true; self::create_campaign_form( $IXAP24 ); break; case 'edit-campaign' : $IXAP538 = true; self::edit_campaign_form( $IXAP24, $IXAP164 ); break; } } } if ( !$IXAP537 && !$IXAP538 ) { $IXAP257 = new Affiliates_Campaign_Table( $IXAP105 ); $IXAP257->prepare_items(); echo '<div class="campaigns">'; echo '<form class="campaigns-table" method="get">'; echo '<div>'; echo '<div class="buttons">'; $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'affiliate_id', $IXAP70 ); $IXAP70 = remove_query_arg( 'action', $IXAP70 ); printf( "<a class='button action' title='%s' href='%s'>%s</a>", esc_attr( __( 'Create a new campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ), esc_url( wp_nonce_url( add_query_arg( array( 'affiliate_id' => $IXAP24, 'action' => 'create-campaign' ), $IXAP70 ) ) ), __( 'Create a Campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); echo '</div>'; echo '<br/>'; if ( isset( $_REQUEST['page'] ) ) { echo sprintf( '<input type="hidden" name="page" value="%s" />', esc_attr( $_REQUEST['page'] ) ); } $IXAP257->display(); echo '</div>'; echo '</form>'; echo '</div>'; } } public static function create_campaign_form( $IXAP24 = null ) { wp_enqueue_style( 'affiliates-campaigns' ); if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( $IXAP24 !== null ) && ( $IXAP24 == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) ) { $name = isset( $_REQUEST['campaign_name'] ) ? stripslashes( wp_strip_all_tags( trim( $_REQUEST['campaign_name'] ) ) ) : ''; $IXAP246 = isset( $_REQUEST['campaign_description'] ) ? stripslashes( substr( wp_strip_all_tags( trim( $_REQUEST['campaign_description'] ) ), 0, self::IXAP518 ) ) : ''; echo '<div class="campaign-create">'; echo '<h2>'; echo __( 'Create Campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</h2>'; printf( '<form action="%s" method="post">', esc_attr( self::current_url_clean() ) ); echo '<div>'; if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { if ( isset( $_REQUEST['affiliate_id'] ) ) { $IXAP24 = intval( $_REQUEST['affiliate_id'] ); } echo '<div class="field affiliate_id">'; echo Affiliates_UI_Elements::affiliates_select( array( 'affiliate_id' => $IXAP24 ) ); echo '</div>'; } else { printf( '<input type="hidden" name="affiliate_id" value="%d" />', intval( $IXAP24 ) ); } echo '<div class="field name">'; echo '<label>'; echo __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; printf( '<input type="text" name="campaign_name" value="%s" />', esc_attr( $name ) ); echo '</label>'; echo '</div>'; echo '<div class="field description">'; echo '<label>'; echo __( 'Description', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; echo '<textarea name="campaign_description">'; echo htmlentities( $IXAP246 ); echo '</textarea>'; echo '</label>'; echo '</div>'; echo '<div class="buttons">'; printf( '<input type="submit" name="campaign-action" class="button button-primary action" value="%s" />', __( 'Create', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); echo '<input type="hidden" name="action" value="create-campaign" />'; echo ' '; self::cancel_link(); wp_nonce_field(); wp_referer_field(); echo '</div>'; echo '</div>'; echo '</form>'; echo '</div>'; } else { wp_die( __( 'Access denied.', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } } public static function edit_campaign_form( $IXAP24, $IXAP164 ) { wp_enqueue_style( 'affiliates-campaigns' ); if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) || ( $IXAP24 !== null ) && ( $IXAP24 == Affiliates_Affiliate_WordPress::get_user_affiliate_id() ) && Affiliates_Campaign::is_affiliate_campaign( $IXAP24, $IXAP164 ) ) { $IXAP530 = new Affiliates_Campaign(); if ( $IXAP530->read( $IXAP164 ) ) { echo '<div class="campaign-edit">'; echo '<h2>'; echo __( 'Edit Campaign', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '</h2>'; printf( '<form action="%s" method="post">', esc_attr( self::current_url_clean() ) ); echo '<div>'; if ( current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { if ( $IXAP361 = Affiliates_Affiliate::get_affiliate( $IXAP24 ) ) { echo '<div class="field name">'; echo '<label>'; echo __( 'Affiliate', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo ' '; printf( '<input type="text" name="affiliate-name" value="%s" readonly="readonly" />', esc_attr( $IXAP361->name ) ); echo '</label>'; echo '</div>'; } } echo '<div class="field name">'; echo '<label>'; echo __( 'Name', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; printf( '<input type="text" name="campaign_name" value="%s" />', esc_attr( stripslashes( $IXAP530->name ) ) ); echo '</label>'; echo '</div>'; echo '<div class="field description">'; echo '<label>'; echo __( 'Description', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ); echo '<br/>'; echo '<textarea name="campaign_description">'; echo htmlentities( stripslashes( $IXAP530->description ) ); echo '</textarea>'; echo '</label>'; echo '</div>'; echo '<div class="buttons">'; printf( '<input type="hidden" name="affiliate_id" value="%d" />', intval( $IXAP24 ) ); printf( '<input type="hidden" name="campaign_id" value="%d" />', intval( $IXAP164 ) ); printf( '<input type="submit" name="campaign-action" class="button button-primary action" value="%s" />', __( 'Save', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); echo '<input type="hidden" name="action" value="edit-campaign" />'; echo ' '; self::cancel_link(); wp_nonce_field(); echo '</div>'; echo '</div>'; echo '</form>'; echo '</div>'; } } } private static function cancel_link() { $IXAP70 = self::current_url_clean(); printf( '<a class="button action" title="%s" href="%s">%s</a>', esc_attr( __( 'Cancel this action', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ), esc_url( $IXAP70 ), __( 'Cancel', AFFILIATES_ENTERPRISE_PLUGIN_DOMAIN ) ); } private static function current_url_clean() { $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'affiliate_id', $IXAP70 ); $IXAP70 = remove_query_arg( 'campaign_id', $IXAP70 ); $IXAP70 = remove_query_arg( 'action', $IXAP70 ); $IXAP70 = remove_query_arg( '_wpnonce', $IXAP70 ); return $IXAP70; } public static function admin_enqueue_scripts() { wp_register_style( 'affiliates-campaigns', AFFILIATES_ENTERPRISE_PLUGIN_URL . 'css/affiliates-campaigns.css', array(), AFFILIATES_EEXT_VERSION ); } public static function wp_enqueue_scripts() { wp_register_script( 'affiliates-campaigns', AFFILIATES_ENTERPRISE_PLUGIN_URL . 'js/affiliates-campaigns.js', array( 'jquery' ), AFFILIATES_EEXT_VERSION, true ); wp_register_style( 'affiliates-campaigns', AFFILIATES_ENTERPRISE_PLUGIN_URL . 'css/affiliates-campaigns.css', array(), AFFILIATES_EEXT_VERSION ); } public static function init() { add_action( 'wp_enqueue_scripts', array( __CLASS__, 'wp_enqueue_scripts' ) ); add_action( 'admin_enqueue_scripts', array( __CLASS__, 'admin_enqueue_scripts' ) ); } } Affiliates_Campaign_Table::init(); 