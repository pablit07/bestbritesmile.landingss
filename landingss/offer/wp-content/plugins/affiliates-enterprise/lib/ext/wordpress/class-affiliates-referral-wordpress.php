<?php
class Affiliates_Referral_WordPress extends Affiliates_Referral { public function suggest( $post_id, $IXAP246 = '', $IXAP212 = null, $IXAP28 = null, $IXAP42 = null, $IXAP247 = null ) { trigger_error( __FUNCTION__ . " is deprecated", E_USER_WARNING ); return $this->evaluate( $post_id, $IXAP246, $IXAP212, null, $IXAP28, $IXAP42, $IXAP247 ); } public function evaluate( $post_id, $IXAP246 = '', $IXAP212 = null, $IXAP248 = null, $IXAP28 = null, $IXAP42 = null, $IXAP247 = null, $IXAP249 = null, $IXAP250 = null, $IXAP251 = false ) { require_once( AFFILIATES_CORE_LIB . '/class-affiliates-service.php' ); $IXAP24 = Affiliates_Service::get_referrer_id(); if ( !$IXAP251 ) { if ( $IXAP24 ) { $IXAP252 = array ( $IXAP24 ); $this->add_referrals( $IXAP252, $post_id, $IXAP246, $IXAP212, $IXAP248, $IXAP28, $IXAP42, $IXAP247, $IXAP249, $IXAP250 ); } } return $IXAP24; } public function suggest_by_attribute( $IXAP253, $IXAP254, $post_id, $IXAP246 = '', $IXAP212 = null, $IXAP248 = null, $IXAP28 = null, $IXAP42 = null, $IXAP247 = null, $IXAP249 = null, $IXAP250 = null, $IXAP251 = false ) { global $wpdb, $affiliates_options; global $affiliates_db; bcscale( AFFILIATES_REFERRAL_AMOUNT_DECIMALS ); $IXAP47 = $affiliates_db->get_tablename( "affiliates" ); $IXAP25 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP56 = date( 'Y-m-d H:i:s', time() ); $IXAP101 = date( 'Y-m-d', time() ); $IXAP252 = $affiliates_db->get_objects( "SELECT a.affiliate_id FROM $IXAP47 a
			LEFT JOIN $IXAP25 aa ON a.affiliate_id = aa.affiliate_id
			WHERE
			aa.attr_key = %s
			AND aa.attr_value = %s
			AND a.from_date <= %s AND ( a.thru_date IS NULL OR a.thru_date >= %s )
			AND a.status = 'active'
			", $IXAP253, $IXAP254, $IXAP101, $IXAP101 ); if ( empty( $IXAP252 ) ) { if ( get_option( 'aff_use_direct', true ) ) { $IXAP252 = array ( (object) array( 'affiliate_id' => affiliates_get_direct_id() ) ); } } if ( !$IXAP251 ) { $IXAP255 = array(); foreach ( $IXAP252 as $IXAP24 ) { $IXAP255[] = $IXAP24->affiliate_id; } $this->add_referrals( $IXAP255, $post_id, $IXAP246, $IXAP212, $IXAP248, $IXAP28, $IXAP42, $IXAP247, $IXAP249, $IXAP250, $IXAP251 ); } return $IXAP252; } public function add_referrals( $IXAP252, $post_id, $IXAP246 = '', $IXAP212 = null, $IXAP248 = null, $IXAP28 = null, $IXAP42 = null, $IXAP247 = null, $IXAP249 = null, $IXAP250 = null, $IXAP251 = false ) { global $affiliates_db; $IXAP47 = $affiliates_db->get_tablename( "affiliates" ); $IXAP25 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP56 = date( 'Y-m-d H:i:s', time() ); $IXAP101 = date( 'Y-m-d', time() ); bcscale( AFFILIATES_REFERRAL_AMOUNT_DECIMALS ); if ( !empty( $IXAP252 ) ) { foreach ( $IXAP252 as $IXAP24 ) { $IXAP256 = wp_get_current_user(); $IXAP56 = date('Y-m-d H:i:s', time() ); $IXAP257 = $affiliates_db->get_tablename( 'referrals' ); $IXAP258 = "(affiliate_id, post_id, datetime, description"; $IXAP259 = "(%d, %d, %s, %s"; $IXAP90 = array($IXAP24, $post_id, $IXAP56, $IXAP246); if ( !empty( $IXAP256 ) ) { $IXAP258 .= ",user_id "; $IXAP259 .= ",%d "; $IXAP90[] = $IXAP256->ID; } $IXAP260 = $_SERVER['REMOTE_ADDR']; if ( PHP_INT_SIZE >= 8 ) { if ( $IXAP261 = ip2long( $IXAP260 ) ) { $IXAP258 .= ',ip '; $IXAP259 .= ',%d '; $IXAP90[] = $IXAP261; } } else { if ( $IXAP261 = ip2long( $IXAP260 ) ) { $IXAP261 = sprintf( '%u', $IXAP261 ); $IXAP258 .= ',ip'; $IXAP259 .= ',%s'; $IXAP90[] = $IXAP261; } } if ( !empty( $IXAP42 ) ) { if ( empty( $IXAP28 ) ) { $IXAP262 = $affiliates_db->get_objects( "SELECT * FROM $IXAP25
								WHERE
								affiliate_id = %d
								AND attr_key IN ('referral.rate','referral.rate.method','referral.amount','referral.amount.method')
								", $IXAP24 ); $IXAP263 = null; $IXAP264 = null; $IXAP265 = null; foreach( $IXAP262 as $IXAP266 ) { switch( $IXAP266->attr_key ) { case 'referral.amount' : $IXAP263 = bcadd( "0", $IXAP266->attr_value ); break; case 'referral.amount.method' : $IXAP264 = bcadd( "0", call_user_func( Affiliates_Referral::get_referral_amount_method( $IXAP266->attr_value ), $IXAP24, array( "affiliate_ids" => $IXAP252, "post_id" => $post_id, "description" => $IXAP246, "data" => $IXAP212, "base_amount" => $IXAP248, "amount" => $IXAP28, "currency_id" => $IXAP42, "status" => $IXAP247, "type" => $IXAP249, "reference" => $IXAP250, "test" => $IXAP251 ) ) ); break; case 'referral.rate' : $IXAP265 = bcmul( $IXAP248, $IXAP266->attr_value ); break; } } if ( $IXAP263 ) { $IXAP28 = $IXAP263; } else if ( $IXAP264 ) { $IXAP28 = $IXAP264; } else if ( $IXAP265 ) { $IXAP28 = $IXAP265; } else { if ( $IXAP267 = Affiliates_Attributes::validate_key( get_option( self::IXAP13, null ) ) ) { if ( $IXAP268 = Affiliates_Attributes::validate_value( $IXAP267, get_option( self::IXAP14, null ) ) ) { switch ( $IXAP267 ) { case 'referral.amount' : $IXAP28 = bcadd( "0", $IXAP268 ); break; case 'referral.amount.method' : $IXAP28 = bcadd( "0", call_user_func( Affiliates_Referral::get_referral_amount_method( $IXAP268 ), $IXAP24, array( "affiliate_ids" => $IXAP252, "post_id" => $post_id, "description" => $IXAP246, "data" => $IXAP212, "base_amount" => $IXAP248, "amount" => $IXAP28, "currency_id" => $IXAP42, "status" => $IXAP247, "type" => $IXAP249, "reference" => $IXAP250, "test" => $IXAP251 ) ) ); break; case 'referral.rate' : $IXAP28 = bcmul( $IXAP248, $IXAP268 ); break; } } } } } if ( !empty( $IXAP28 ) ) { if ( $IXAP28 = Affiliates_Utility::verify_referral_amount( $IXAP28 ) ) { if ( $IXAP42 = Affiliates_Utility::verify_currency_id( $IXAP42 ) ) { $IXAP258 .= ",amount "; $IXAP259 .= ",%s "; $IXAP90[] = $IXAP28; $IXAP258 .= ",currency_id "; $IXAP259 .= ",%s "; $IXAP90[] = $IXAP42; } } } } if ( is_array( $IXAP212 ) && !empty( $IXAP212 ) ) { $IXAP258 .= ",data "; $IXAP259 .= ",%s "; $IXAP90[] = serialize( $IXAP212 ); } if ( !empty( $IXAP247 ) && Affiliates_Utility::verify_referral_status_transition( $IXAP247, $IXAP247 ) ) { $IXAP258 .= ',status '; $IXAP259 .= ',%s '; $IXAP90[] = $IXAP247; } else { $IXAP258 .= ',status '; $IXAP259 .= ',%s '; $IXAP90[] = get_option( 'aff_default_referral_status', AFFILIATES_REFERRAL_STATUS_ACCEPTED ); } if ( !empty( $IXAP249 ) ) { $IXAP258 .= ',type '; $IXAP259 .= ',%s '; $IXAP90[] = $IXAP249; } if ( !empty( $IXAP250 ) ) { $IXAP258 .= ',reference '; $IXAP259 .= ',%s '; $IXAP90[] = $IXAP250; } $IXAP164 = null; require_once( AFFILIATES_CORE_LIB . '/class-affiliates-service.php' ); if ( $IXAP269 = Affiliates_Service::get_ids() ) { if ( !empty( $IXAP269['affiliate_id'] ) && !empty( $IXAP269['campaign_id'] ) ) { if ( $IXAP269['affiliate_id'] == $IXAP24 ) { $IXAP258 .= ',campaign_id '; $IXAP259 .= ',%d '; $IXAP164 = intval( $IXAP269['campaign_id'] ); $IXAP90[] = $IXAP164; } } } $IXAP258 .= ")"; $IXAP259 .= ")"; if ( !$IXAP251 ) { $IXAP270 = explode( ',', str_replace( ' ', '', substr( $IXAP258, 1, strlen( $IXAP258 ) - 2 ) ) ); $IXAP271 = array_combine( $IXAP270, $IXAP90 ); $IXAP272 = apply_filters( 'affiliates_record_referral', true, $IXAP271 ); if ( $IXAP272 ) { if ( !affiliates_is_duplicate_referral( array( 'affiliate_id' => $IXAP24, 'amount' => $IXAP28, 'currency_id' => $IXAP42, 'type' => $IXAP249, 'reference' => $IXAP250, 'data' => $IXAP212 ) ) ) { if ( $affiliates_db->query( "INSERT INTO $IXAP257 $IXAP258 VALUES $IXAP259", $IXAP90 ) !== false ) { if ( $IXAP273 = $affiliates_db->get_value( "SELECT LAST_INSERT_ID()" ) ) { do_action( 'affiliates_referral', $IXAP273, array( 'affiliate_id' => $IXAP24, 'post_id' => $post_id, 'description' => $IXAP246, 'data' => $IXAP212, 'base_amount' => $IXAP248, 'amount' => $IXAP28, 'currency_id' => $IXAP42, 'status' => $IXAP247, 'type' => $IXAP249, 'reference' => $IXAP250, 'test' => $IXAP251, 'campaign_id' => $IXAP164 ) ); } } } } } } } return $IXAP252; } public function __construct( $IXAP273 = null ) { if ( $IXAP273 !== null ) { global $affiliates_db; $IXAP49 = $affiliates_db->get_tablename( 'referrals' ); if ( $IXAP222 = $affiliates_db->get_objects( "SELECT * FROM $IXAP49 WHERE referral_id = %d", $IXAP273 ) ) { if ( count( $IXAP222 ) > 0 ) { $this->referral = $IXAP222[0]; } } if ( $this->referral === null ) { throw new Exception(); } } } public function update( $IXAP274 ) { global $affiliates_db; $IXAP15 = null; if ( $this->referral !== null ) { $IXAP275 = array(); $IXAP270 = array(); $IXAP90 = array(); $IXAP276 = array(); foreach( $IXAP274 as $IXAP78 => $IXAP87 ) { $IXAP277 = isset( $this->referral->$IXAP78 ) ? $this->referral->$IXAP78 : null; if ( $IXAP277 !== $IXAP87 ) { switch( $IXAP78 ) { case 'affiliate_id' : case 'post_id' : $IXAP275[] = " $IXAP78 = %d "; $IXAP270[] = $IXAP78; $IXAP90[] = intval( $IXAP87 ); $IXAP276[] = $IXAP277; break; case 'datetime' : case 'description' : case 'reference' : $IXAP275[] = " $IXAP78 = %s "; $IXAP270[] = $IXAP78; $IXAP90[] = $IXAP87; $IXAP276[] = $IXAP277; break; case 'status' : if ( !empty( $IXAP87 ) && Affiliates_Utility::verify_referral_status_transition( $IXAP87, $IXAP87 ) ) { $IXAP275[] = " $IXAP78 = %s "; $IXAP270[] = $IXAP78; $IXAP90[] = $IXAP87; $IXAP276[] = $IXAP277; } break; case 'amount' : if ( $IXAP87 = Affiliates_Utility::verify_referral_amount( $IXAP87 ) ) { $IXAP275[] = " $IXAP78 = %s "; $IXAP270[] = $IXAP78; $IXAP90[] = $IXAP87; $IXAP276[] = $IXAP277; } break; case 'currency_id' : if ( $IXAP87 = Affiliates_Utility::verify_currency_id( $IXAP87 ) ) { $IXAP275[] = " $IXAP78 = %s "; $IXAP270[] = $IXAP78; $IXAP90[] = $IXAP87; $IXAP276[] = $IXAP277; } break; } } } if ( count( $IXAP275 ) > 0 ) { $IXAP275 = implode( ' , ', $IXAP275 ); $IXAP49 = $affiliates_db->get_tablename( 'referrals' ); if ( $affiliates_db->query( "UPDATE $IXAP49 SET $IXAP275 WHERE referral_id = %d", array_merge( $IXAP90, array( intval( $this->referral->referral_id ) ) ) ) ) { if ( $IXAP222 = $affiliates_db->get_objects( "SELECT * FROM $IXAP49 WHERE referral_id = %d", intval( $this->referral->referral_id ) ) ) { if ( count( $IXAP222 ) > 0 ) { $this->referral = $IXAP222[0]; } } $IXAP15 = array( 'keys' => $IXAP270, 'values' => $IXAP90, 'old_values' => $IXAP276 ); do_action( 'affiliates_updated_referral', intval( $this->referral->referral_id ), $IXAP270, $IXAP90, $IXAP276 ); } } } return $IXAP15; } }