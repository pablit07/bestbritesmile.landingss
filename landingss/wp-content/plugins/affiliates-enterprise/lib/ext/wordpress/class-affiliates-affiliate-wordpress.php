<?php
 class Affiliates_Affiliate_WordPress extends Affiliates_Affiliate { public static function get_user_affiliate_id( $IXAP9 = null ) { global $affiliates_db; $IXAP15 = false; $IXAP95 = null; if ( $IXAP9 === null ) { if ( is_user_logged_in() ) { $IXAP95 = wp_get_current_user(); } } else { $IXAP95 = get_user_by( 'id', $IXAP9 ); } if ( $IXAP95 ) { $IXAP15 = parent::get_user_affiliate_id( $IXAP95->ID ); } return $IXAP15; } public static function update_name( $IXAP24, $name ) { global $affiliates_db; $IXAP15 = false; $IXAP361 = self::get_affiliate( $IXAP24 ); if ( $IXAP361 ) { $name = Affiliates_Utility::filter( $name ); if ( !empty( $name ) ) { $IXAP430 = $IXAP361->name; if ( $IXAP430 != $name ) { $IXAP47 = $affiliates_db->get_tablename( 'affiliates' ); if ( $affiliates_db->query( "UPDATE $IXAP47 SET name = %s WHERE affiliate_id = %d", $name, $IXAP24 ) ) { $IXAP15 = $name; do_action( 'affiliates_updated_name', $IXAP24, $IXAP430, $name ); do_action( 'affiliates_updated_affiliate', intval( $IXAP24 ) ); } } } } return $IXAP15; } public static function update_email( $IXAP24, $IXAP32 ) { global $affiliates_db; $IXAP15 = false; $IXAP361 = self::get_affiliate( $IXAP24 ); if ( $IXAP361 ) { if ( $IXAP32 = Affiliates_Validator::validate_email( $IXAP32 ) ) { $IXAP431 = $IXAP361->email; if ( $IXAP431 != $IXAP32 ) { $IXAP47 = $affiliates_db->get_tablename( 'affiliates' ); if ( $affiliates_db->query( "UPDATE $IXAP47 SET email = %s WHERE affiliate_id = %d", $IXAP32, $IXAP24 ) ) { $IXAP15 = $IXAP32; do_action( 'affiliates_updated_email', $IXAP24, $IXAP431, $IXAP32 ); do_action( 'affiliates_updated_affiliate', intval( $IXAP24 ) ); } } } } return $IXAP15; } public static function update_attribute( $IXAP24, $IXAP78, $IXAP87 ) { global $affiliates_db; $IXAP15 = false; $IXAP361 = self::get_affiliate( $IXAP24 ); if ( $IXAP361 && Affiliates_Attributes::validate_key( $IXAP78 ) ) { if ( $IXAP87 = Affiliates_Attributes::validate_value( $IXAP78, $IXAP87 ) ) { $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP374 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", $IXAP24, $IXAP78 ); if ( $IXAP374 != $IXAP87 ) { if ( $affiliates_db->query( "INSERT INTO $IXAP25 SET affiliate_id = %d, attr_key = %s, attr_value = %s ON DUPLICATE KEY UPDATE attr_value = %s", $IXAP24, $IXAP78, $IXAP87, $IXAP87 ) ) { $IXAP15 = $IXAP87; do_action( 'affiliates_updated_attribute', $IXAP24, $IXAP78, $IXAP374, $IXAP87 ); do_action( 'affiliates_updated_affiliate', intval( $IXAP24 ) ); } } } } return $IXAP15; } function edit( $IXAP24 ) { global $wpdb; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP361 = affiliates_get_affiliate( intval( $IXAP24 ) ); if ( empty( $IXAP361 ) ) { wp_die( __( 'No such affiliate.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP48 = _affiliates_get_tablename( 'affiliates_users' ); $IXAP432 = null; $IXAP433 = ''; $IXAP434 = ''; $IXAP435 = $wpdb->get_var( $wpdb->prepare( "SELECT user_id FROM $IXAP48 WHERE affiliate_id = %d", intval( $IXAP24 ) ) ); if ( $IXAP435 !== null ) { $IXAP432 = get_user_by( 'id', intval( $IXAP435 ) ); if ( $IXAP432 ) { if ( current_user_can( 'edit_user', $IXAP432->ID ) ) { $IXAP433 = sprintf( __( 'Edit %s', AFFILIATES_PRO_PLUGIN_DOMAIN ) , '<a target="_blank" href="' . esc_url( "user-edit.php?user_id=$IXAP432->ID" ) . '">' . $IXAP432->user_login . '</a>' ); } require_once AFFILIATES_CORE_LIB . '/class-affiliates-settings.php'; require_once AFFILIATES_CORE_LIB . '/class-affiliates-settings-registration.php'; $IXAP348 = Affiliates_Settings_Registration::get_fields(); foreach( Affiliates_Registration::get_skip_meta_fields() as $IXAP78 ) { unset( $IXAP348[$IXAP78] ); } foreach( $IXAP348 as $name => $IXAP210 ) { if ( $IXAP210['enabled'] ) { $IXAP434 .= '<div class="field">'; $IXAP434 .= '<label>'; $IXAP434 .= esc_html( stripslashes( $IXAP210['label'] ) ); $IXAP434 .= ' '; $IXAP249 = isset( $IXAP210['type'] ) ? $IXAP210['type'] : 'text'; $IXAP87 = get_user_meta( $IXAP432->ID, $name , true ); $IXAP434 .= sprintf( '<input type="text" value="%s" readonly="readonly" />', esc_attr( stripslashes( $IXAP87 ) ) ); $IXAP434 .= '</label>'; $IXAP434 .= '</div>'; } } } } $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'action', $IXAP70 ); $IXAP70 = remove_query_arg( 'affiliate_id', $IXAP70 ); $name = isset( $_POST['name-field'] ) ? $_POST['name-field'] : $IXAP361['name']; $IXAP32 = isset( $_POST['email-field'] ) ? $_POST['email-field'] : $IXAP361['email']; $IXAP60 = isset( $_POST['user-field'] ) ? $_POST['user-field'] : ( $IXAP432 != null ? $IXAP432->user_login : '' ); $IXAP36 = isset( $_POST['from-date-field'] ) ? $_POST['from-date-field'] : $IXAP361['from_date']; $IXAP38 = isset( $_POST['thru-date-field'] ) ? $_POST['thru-date-field'] : $IXAP361['thru_date']; $IXAP62 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __( 'Edit an affiliate', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h1>' . '</div>' . '<form id="edit-affiliate" action="' . esc_url( $IXAP70 ) . '" method="post">' . '<div class="affiliate edit">' . '<input id="affiliate-id-field" name="affiliate-id-field" type="hidden" value="' . esc_attr( intval( $IXAP24 ) ) . '"/>' . '<div class="field">' . '<label class="field-label first required">' . '<span class="label">' . __( 'Name', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span>' . ' ' . '<input id="name-field" name="name-field" class="namefield" type="text" value="' . esc_attr( stripslashes( $name ) ) . '"/>' . '</label>' . '</div>' . '<div class="field">' . '<label for="email-field" class="field-label">' . '<span class="label">' . __( 'Email', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span>' . ' ' . '<input id="email-field" name="email-field" class="emailfield" type="text" value="' . esc_attr( $IXAP32 ) . '"/>' . '</label>' . ' ' . '<span class="description">' . __( "If a valid <strong>Username</strong> is specified and no email is given, the user's email address will be used automatically.", AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span>' . '</div>' . '<div class="field">' . '<label for="user-field" class="field-label">' . '<span class="label">' . __( 'Username', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span>' . ' ' . '<input id="user-field" name="user-field" class="userfield" type="text" value="' . esc_attr( stripslashes( $IXAP60 ) ) . '"/>' . '</label>' . ' ' . $IXAP433 . '</div>' . $IXAP434 . '<div class="field">' . '<label class="field-label first">' . '<span class="label">' . __( 'From', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span>' . ' ' . '<input id="from-date-field" name="from-date-field" class="datefield" type="text" value="' . esc_attr( $IXAP36 ) . '"/>' . '</label>' . '</div>' . '<div class="field">' . '<label class="field-label">' . '<span class="label">' . __( 'Until', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</span>' . ' ' . '<input id="thru-date-field" name="thru-date-field" class="datefield" type="text" value="' . esc_attr( $IXAP38 ) . '"/>' . '</label>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __( 'Save', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="edit" name="action"/>' . ' ' . '<a class="button" class="cancel" href="' . esc_url( $IXAP70 ) . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP62; do_action( 'affiliates_after_edit_affiliate_form', $IXAP24 ); $IXAP274 = new Affiliates_Attributes_WordPress(); $IXAP274->view( $IXAP24 ); do_action( 'affiliates_after_edit_affiliate_attributes', $IXAP24 ); affiliates_footer(); } function edit_submit() { global $wpdb; $IXAP15 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP47 = _affiliates_get_tablename( 'affiliates' ); $IXAP48 = _affiliates_get_tablename( 'affiliates_users' ); $IXAP24 = isset( $_POST['affiliate-id-field'] ) ? $_POST['affiliate-id-field'] : null; $IXAP436 = false; $IXAP361 = null; if ( $IXAP361 = $wpdb->get_row( $wpdb->prepare( "SELECT affiliate_id FROM $IXAP47 WHERE affiliate_id = %d", intval( $IXAP24 ) ) ) ) { $IXAP436 = isset( $IXAP361->type ) && ( $IXAP361->type == AFFILIATES_DIRECT_TYPE ); } if ( empty( $IXAP361 ) ) { wp_die( __( 'No such affiliate.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP437 = self::get_affiliate( $IXAP24 ); $name = isset( $_POST['name-field'] ) ? $_POST['name-field'] : null; if ( $IXAP436 ) { $name = AFFILIATES_DIRECT_NAME; } if ( !empty( $name ) ) { $IXAP212 = array( 'name' => $name ); $IXAP259 = array( '%s' ); $IXAP32 = trim( $_POST['email-field'] ); if ( is_email( $IXAP32 ) ) { $IXAP212['email'] = $IXAP32; $IXAP259[] = '%s'; } else { $IXAP212['email'] = null; $IXAP259[] = 'NULL'; } $IXAP36 = $_POST['from-date-field']; if ( empty( $IXAP36 ) ) { $IXAP36 = date( 'Y-m-d', time() ); } else { $IXAP36 = date( 'Y-m-d', strtotime( $IXAP36 ) ); } $IXAP212['from_date'] = $IXAP36; $IXAP259[] = '%s'; $IXAP38 = $_POST['thru-date-field']; if ( !empty( $IXAP38 ) && strtotime( $IXAP38 ) < strtotime( $IXAP36 ) ) { $IXAP38 = null; } if ( !empty( $IXAP38 ) ) { $IXAP38 = date( 'Y-m-d', strtotime( $IXAP38 ) ); $IXAP212['thru_date'] = $IXAP38; $IXAP259[] = '%s'; } else { $IXAP212['thru_date'] = null; $IXAP259[] = 'NULL'; } $IXAP438 = array(); $IXAP90 = array(); $IXAP439 = 0; foreach( $IXAP212 as $IXAP78 => $IXAP87 ) { $IXAP438[] = $IXAP78 . ' = ' . $IXAP259[$IXAP439]; if ( $IXAP87 ) { $IXAP90[] = $IXAP87; } $IXAP439++; } if ( !empty( $IXAP438 ) ) { $IXAP438 = implode( ', ', $IXAP438 ); $IXAP90[] = intval( $IXAP24 ); $IXAP98 = $wpdb->prepare( "UPDATE $IXAP47 SET $IXAP438 WHERE affiliate_id = %d", $IXAP90 ); $wpdb->query( $IXAP98 ); } $IXAP440 = $wpdb->get_row( $wpdb->prepare(" SELECT affiliate_id, user_id, user_login FROM $IXAP48 LEFT JOIN $wpdb->users ON $IXAP48.user_id = $wpdb->users.ID WHERE affiliate_id = %d", intval( $IXAP24 ) ) ); $IXAP441 = trim( $_POST['user-field'] ); if ( ( empty( $IXAP441 ) && !empty( $IXAP440 ) ) || ( !empty( $IXAP440 ) && ( strcmp( $IXAP440->user_login, $IXAP441 ) !== 0 ) ) ) { $wpdb->query( $wpdb->prepare( "DELETE FROM $IXAP48 WHERE affiliate_id = %d", intval( $IXAP24 ) ) ); } if ( !empty( $IXAP24 ) && !empty( $IXAP441 ) && ( empty( $IXAP440 ) || ( !empty( $IXAP440 ) && ( strcmp( $IXAP440->user_login, $IXAP441 ) !== 0 ) ) ) ) { $IXAP442 = get_user_by( 'login', $IXAP441 ); if ( !empty( $IXAP442 ) ) { if ( $wpdb->query( $wpdb->prepare( "INSERT INTO $IXAP48 SET affiliate_id = %d, user_id = %d", intval( $IXAP24 ), intval( $IXAP442->ID ) ) ) ) { if ( empty( $IXAP32 ) && !empty( $IXAP442->user_email ) ) { $wpdb->query( $wpdb->prepare( "UPDATE $IXAP47 SET email = %s WHERE affiliate_id = %d", $IXAP442->user_email, $IXAP24 ) ); } } } } $IXAP443 = self::get_affiliate( $IXAP24 ); if ( $IXAP437->name != $IXAP443->name ) { do_action( 'affiliates_updated_name', $IXAP24, $IXAP437->name, $IXAP443->name ); } if ( $IXAP437->email != $IXAP443->email ) { do_action( 'affiliates_updated_email', $IXAP24, $IXAP437->email, $IXAP443->email ); } if ( !empty( $IXAP24 ) ) { do_action( 'affiliates_updated_affiliate', intval( $IXAP24 ) ); } } else { $IXAP15 = false; } return $IXAP15; } } 