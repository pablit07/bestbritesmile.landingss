<?php
class Affiliates_Attributes_WordPress extends Affiliates_Attributes { function view( $IXAP24 ) { global $wpdb, $affiliates_options, $affiliates_db; $IXAP62 = ''; $IXAP360 = new Affiliates_Affiliate_WordPress(); $IXAP361 = $IXAP360->get_affiliate( $IXAP24 ); if ( $IXAP361 ) { $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'action', $IXAP70 ); $IXAP70 = remove_query_arg( 'affiliate_id', $IXAP70 ); $IXAP187 = isset( $_POST['row_count'] ) ? intval( $_POST['row_count'] ) : 0; if ($IXAP187 <= 0) { $IXAP187 = $affiliates_options->get_option( 'affiliates_attributes_per_page', AFFILIATES_HITS_PER_PAGE ); } else { $affiliates_options->update_option('affiliates_attributes_per_page', $IXAP187 ); } $IXAP189 = isset( $_GET['offset'] ) ? intval( $_GET['offset'] ) : 0; if ( $IXAP189 < 0 ) { $IXAP189 = 0; } $IXAP190 = isset( $_REQUEST['paged'] ) ? intval( $_REQUEST['paged'] ) : 0; if ( $IXAP190 < 0 ) { $IXAP190 = 0; } $IXAP62 .= '<div class="manage-affiliates">' . '<div>' . '<h2>' . __( 'Affiliate Attributes', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h2>' . '</div>'; $IXAP62 .= '<div class="manage">' . "<a title='" . __( 'Click to add a new attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . "' class='add' href='" . esc_url( $IXAP70 ) . "&action=add-attribute&affiliate_id=" . urlencode( $IXAP24 ) . "'><img class='icon' alt='" . __( 'Add', AFFILIATES_PRO_PLUGIN_DOMAIN) . "' src='". AFFILIATES_PRO_PLUGIN_URL ."images/add.png'/><span class='label'>" . __( 'New Attribute', AFFILIATES_PRO_PLUGIN_DOMAIN) . "</span></a>" . '</div>'; $IXAP62 .= '<div class="affiliates-attributes-overview">'; $IXAP76 = array( 'attr_key' => __( 'Id', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'attr_value' => __( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'edit' => __( 'Edit', AFFILIATES_PRO_PLUGIN_DOMAIN ), 'remove' => __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); $IXAP62 .= '
				<table id="" class="wp-list-table widefat fixed" cellspacing="0">
				<thead>
					<tr>
					'; foreach ( $IXAP76 as $IXAP78 => $IXAP79 ) { $IXAP62 .= "<th scope='col' class='$IXAP78'>$IXAP79</th>"; } $IXAP62 .= '</tr>
				</thead>
				<tbody>
				'; $IXAP25 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP220 = $affiliates_db->get_objects("SELECT * FROM $IXAP25 WHERE affiliate_id = %d", $IXAP24 ); if ( !empty( $IXAP220 ) ) { $IXAP270 = Affiliates_Attributes::get_keys(); $IXAP80 = 0; foreach ( $IXAP220 as $IXAP362 ) { $IXAP293 = ''; $IXAP295 = ''; $IXAP62 .= '<tr class="' . $IXAP293 . $IXAP295 . ( $IXAP80 % 2 == 0 ? 'even' : 'odd' ) . '">'; $IXAP62 .= '<td>' . wp_filter_kses( $IXAP270[$IXAP362->attr_key] ) . '</td>'; $IXAP363 = @unserialize( $IXAP362->attr_value ); if ( $IXAP363 !== false ) { $IXAP87 = $IXAP363; } else { $IXAP87 = $IXAP362->attr_value; } if ( is_array( $IXAP87 ) ) { $IXAP87 = implode( "::", $IXAP87 ); } $IXAP62 .= '<td>' . wp_filter_kses( $IXAP87 ) . '</td>'; $IXAP62 .= "<td class='edit'><a href='" . esc_url( $IXAP70 ) . "&action=edit-attribute&affiliate_id=" . urlencode( $IXAP24 ) . "&attr_key=" . urlencode( $IXAP362->attr_key ) . "' alt='" . __( 'Edit', AFFILIATES_PRO_PLUGIN_DOMAIN) . "'><img src='". AFFILIATES_PRO_PLUGIN_URL ."images/edit.png'/></a></td>"; $IXAP62 .= "<td class='remove'><a href='" . esc_url( $IXAP70 ) . "&action=remove-attribute&affiliate_id=" . urlencode( $IXAP24 ) . "&attr_key=" . urlencode( $IXAP362->attr_key ) . "' alt='" . __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN) . "'><img src='". AFFILIATES_PRO_PLUGIN_URL ."images/remove.png'/></a></td>"; $IXAP62 .= '</tr>'; $IXAP80++; } $IXAP62 .= '</table>'; $IXAP62 .= '</td>'; $IXAP62 .= '</tr>'; } else { $IXAP62 .= '<tr><td colspan="' . count( $IXAP76 ) . '">' . __('There are no results.', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</td></tr>'; } $IXAP62 .= '</tbody>'; $IXAP62 .= '</table>'; $IXAP62 .= '</div>'; $IXAP62 .= '</div>'; } echo $IXAP62; } function add( $IXAP24 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'action', $IXAP70 ); $IXAP70 = remove_query_arg( 'affiliate_id', $IXAP70 ); $IXAP364 = esc_url( $IXAP70 ) . "&action=edit&affiliate_id=" . urlencode( $IXAP24 ); $IXAP70 = remove_query_arg( 'paged', $IXAP70 ); $IXAP24 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $IXAP24; $IXAP356 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : ''; $IXAP359 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : ''; $IXAP365 = array(); $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP366 = $affiliates_db->get_objects( "SELECT * FROM $IXAP25 WHERE affiliate_id = %d", $IXAP24 ); foreach( $IXAP366 as $IXAP367 ) { $IXAP365[] = $IXAP367->attr_key; } $IXAP368 = '<select id="attr-key-field" name="attr-key-field" class="attr-key-field">'; $IXAP270 = Affiliates_Attributes::get_keys(); foreach( $IXAP270 as $IXAP78 => $name ) { if ( !in_array( $IXAP78, $IXAP365 ) ) { $IXAP289 = $IXAP356 == $IXAP78 ? ' selected="selected" ' : ''; $IXAP368 .= '<option value="' . esc_attr( $IXAP78 ) . '" ' . $IXAP289 . '>' . wp_filter_kses( $name ) . '</option>'; } } $IXAP368 .= '</select>'; $IXAP62 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __( 'Add a new attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h1>' . '</div>' . '<form id="add-attribute" action="' . esc_url( $IXAP70 ) . '" method="post">' . '<div class="affiliate new">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . $IXAP368 . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP359 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __( 'Add', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $IXAP24 ) . '" name="affiliate_id"/>' . '<input type="hidden" value="add-attribute" name="action"/>' . ' ' . '<a class="cancel button" href="' . $IXAP364 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP62; } function add_submit() { global $wpdb, $affiliates_db, $IXAP1; $IXAP15 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP24 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP356 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; $IXAP359 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : null; if ( $IXAP359 !== null ) { $IXAP359 = Affiliates_Attributes::validate_value( $IXAP356, $IXAP359 ); if ( $IXAP359 !== false ) { if ( is_array( $IXAP359 ) || is_object( $IXAP359 ) ) { $IXAP359 = serialize( $IXAP359 ); } } else { $IXAP359 = null; } } $IXAP369 = false; if ( ( $IXAP356 == Affiliates_Attributes::IXAP86 ) && !empty( $IXAP359 ) ) { $IXAP370 = explode( ",", $IXAP359 ); foreach( $IXAP370 as $IXAP371 ) { $IXAP371 = trim( $IXAP371 ); $IXAP372 = self::get_affiliate_for_coupon( $IXAP371 ); if ( ( $IXAP372 !== null ) && ( $IXAP372 != $IXAP24 ) ) { $IXAP1[] = '<div class="error">' . sprintf( __( 'Coupons may not be assigned to multiple affiliates. The coupon code <strong>%s</strong> has already been assigned to the affiliate with Id %d.', AFFILIATES_PRO_PLUGIN_DOMAIN), $IXAP371, $IXAP372 ) . '</div>'; $IXAP369 = true; } } } if ( $IXAP369 ) { return false; } if ( !empty( $IXAP24 ) && Affiliates_Attributes::validate_key( $IXAP356 ) && ( $IXAP359 !== null ) ) { if ( !$affiliates_db->get_value( "SELECT * FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", $IXAP24, $IXAP356 ) ) { if ( $affiliates_db->query( "INSERT INTO $IXAP25 SET affiliate_id=%d, attr_key=%s, attr_value=%s", $IXAP24, $IXAP356, $IXAP359 ) ) { do_action( 'affiliates_added_attribute', $IXAP24, $IXAP356, $IXAP359 ); } } else { $IXAP1[] = '<div class="error">' . __( 'Duplicate key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } } else { $IXAP1[] = '<div class="error">' . __( 'Invalid data', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } return $IXAP15; } function edit( $IXAP24, $IXAP356 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'action', $IXAP70 ); $IXAP70 = remove_query_arg( 'affiliate_id', $IXAP70 ); $IXAP364 = esc_url( $IXAP70 ) . "&action=edit&affiliate_id=" . urlencode( $IXAP24 ); $IXAP70 = remove_query_arg( 'paged', $IXAP70 ); $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP359 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", $IXAP24, $IXAP356 ); $IXAP24 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $IXAP24; $IXAP356 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : $IXAP356; $IXAP359 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : $IXAP359; $IXAP373 = @unserialize( $IXAP359 ); if ( $IXAP373 === false ) { $IXAP373 = $IXAP359; } if ( is_array( $IXAP373 ) ) { $IXAP373 = implode( "::", $IXAP373 ); } $IXAP270 = Affiliates_Attributes::get_keys(); $IXAP62 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __( 'Edit an attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h1>' . '</div>' . '<form id="edit-attribute" action="' . esc_url( $IXAP70 ) . '" method="post">' . '<div class="affiliate-attribute edit">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-name-field" name="attr-name-field" class="attr-name-field" type="text" value="' . esc_attr( $IXAP270[$IXAP356] ) . '"/>' . '<input type="hidden" name="attr-key-field" value="' . esc_attr( $IXAP356 ) . '"/>' . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP373 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __( 'Save', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $IXAP24 ) . '" name="affiliate_id"/>' . '<input type="hidden" value="edit-attribute" name="action"/>' . ' ' . '<a class="cancel button" href="' . $IXAP364 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP62; } function edit_submit() { global $wpdb, $affiliates_db, $IXAP1; $IXAP15 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP24 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP356 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; $IXAP359 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : null; if ( $IXAP359 !== null ) { $IXAP359 = Affiliates_Attributes::validate_value( $IXAP356, $IXAP359 ); if ( $IXAP359 !== false ) { if ( is_array( $IXAP359 ) || is_object( $IXAP359 ) ) { $IXAP359 = serialize( $IXAP359 ); } } else { $IXAP359 = null; } } $IXAP369 = false; if ( ( $IXAP356 == Affiliates_Attributes::IXAP86 ) && !empty( $IXAP359 ) ) { $IXAP370 = explode( ",", $IXAP359 ); foreach( $IXAP370 as $IXAP371 ) { $IXAP371 = trim( $IXAP371 ); $IXAP372 = self::get_affiliate_for_coupon( $IXAP371 ); if ( ( $IXAP372 !== null ) && ( $IXAP372 != $IXAP24 ) ) { $IXAP1[] = '<div class="error">' . sprintf( __( 'Coupons may not be assigned to multiple affiliates. The coupon code <strong>%s</strong> has already been assigned to the affiliate with Id %d.', AFFILIATES_PRO_PLUGIN_DOMAIN), $IXAP371, $IXAP372 ) . '</div>'; $IXAP369 = true; } } } if ( $IXAP369 ) { return false; } if ( !empty( $IXAP24 ) && Affiliates_Attributes::validate_key( $IXAP356 ) && ( $IXAP359 !== null ) ) { if ( $IXAP374 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", $IXAP24, $IXAP356 ) ) { if ( $affiliates_db->query( "UPDATE $IXAP25 SET attr_value=%s WHERE affiliate_id=%d AND attr_key=%s", $IXAP359 , $IXAP24, $IXAP356 ) ) { do_action( 'affiliates_updated_attribute', $IXAP24, $IXAP356, $IXAP374, $IXAP359 ); } } else { $IXAP1[] = '<div class="error">' . __( 'Invalid key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } } else { $IXAP1[] = '<div class="error">' . __( 'Invalid data', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</div>'; $IXAP15 = false; } return $IXAP15; } function remove( $IXAP24, $IXAP356 ) { global $affiliates_db; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } affiliates_pro_admin_notices(); $IXAP70 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IXAP70 = remove_query_arg( 'action', $IXAP70 ); $IXAP70 = remove_query_arg( 'affiliate_id', $IXAP70 ); $IXAP364 = esc_url( $IXAP70 ) . "&action=edit&affiliate_id=" . urlencode( $IXAP24 ); $IXAP70 = remove_query_arg( 'paged', $IXAP70 ); $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP359 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", $IXAP24, $IXAP356 ); $IXAP24 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : $IXAP24; $IXAP356 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : $IXAP356; $IXAP359 = isset( $_POST['attr-value-field'] ) ? $_POST['attr-value-field'] : $IXAP359; $IXAP373 = @unserialize( $IXAP359 ); if ( $IXAP373 === false ) { $IXAP373 = $IXAP359; } if ( is_array( $IXAP373 ) ) { $IXAP373 = implode( "::", $IXAP373 ); } $IXAP270 = Affiliates_Attributes::get_keys(); $IXAP62 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __( 'Remove an attribute', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</h1>' . '</div>' . '<form id="remove-attribute" action="' . esc_url( $IXAP70 ) . '" method="post">' . '<div class="affiliate-attribute remove">' . '<div class="field">' . '<label for="attr-key-field" class="field-label first required">' .__( 'Key', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-name-field" name="attr-name-field" class="attr-name-field" type="text" value="' . esc_attr( $IXAP270[$IXAP356] ) . '"/>' . '<input type="hidden" name="attr-key-field" value="' . esc_attr( $IXAP356 ) . '"/>' . '</div>' . '<div class="field">' . '<label for="attr-value-field" class="field-label first required">' .__( 'Value', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</label>' . '<input readonly="readonly" id="attr-value-field" name="attr-value-field" class="attr-value-field" type="text" value="' . esc_attr( $IXAP373 ) . '"/>' . '</div>' . '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __( 'Remove', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '"/>' . '<input type="hidden" value="' . esc_attr( $IXAP24 ) . '" name="affiliate_id"/>' . '<input type="hidden" value="remove-attribute" name="action"/>' . ' ' . '<a class="cancel button" href="' . $IXAP364 . '">' . __( 'Cancel', AFFILIATES_PRO_PLUGIN_DOMAIN ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IXAP62; } function remove_submit() { global $wpdb, $affiliates_db, $IXAP1; $IXAP15 = true; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } if ( !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( 'Access denied.', AFFILIATES_PRO_PLUGIN_DOMAIN ) ); } $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IXAP24 = isset( $_POST['affiliate_id'] ) ? $_POST['affiliate_id'] : null; $IXAP356 = isset( $_POST['attr-key-field'] ) ? $_POST['attr-key-field'] : null; if ( !( empty( $IXAP24 ) || empty( $IXAP356 ) ) ) { $IXAP359 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", $IXAP24, $IXAP356 ); if ( $affiliates_db->query( "DELETE FROM $IXAP25 WHERE affiliate_id=%d AND attr_key=%s", $IXAP24, $IXAP356 ) ) { do_action( 'affiliates_removed_attribute', $IXAP24, $IXAP356, $IXAP359 ); } } else { $IXAP15 = false; } return $IXAP15; } public static function get_affiliate_for_coupon( $IXAP371 ) { global $affiliates_db; $IXAP25 = $affiliates_db->get_tablename( "affiliates_attributes" ); $IXAP375 = $affiliates_db->get_objects( "SELECT * FROM $IXAP25 WHERE attr_key = %s AND attr_value LIKE '%%%s%%'", Affiliates_Attributes::IXAP86, $IXAP371 ); $IXAP24 = null; foreach( $IXAP375 as $IXAP376 ) { $IXAP377 = explode( ",", $IXAP376->attr_value ); foreach( $IXAP377 as $IXAP378 ) { $IXAP378 = trim( $IXAP378 ); if ( $IXAP378 === $IXAP371 ) { $IXAP24 = $IXAP376->affiliate_id; break; } } if ( $IXAP24 !== null ) { break; } } return apply_filters( 'affiliates_coupon_affiliate_id', $IXAP24, $IXAP371 ); } public static function get_coupons_for_affiliate( $IXAP24 ) { global $affiliates_db; $IXAP15 = array(); $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); if ( $IXAP370 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", intval( $IXAP24 ), Affiliates_Attributes::IXAP86 ) ) { $IXAP15 = explode( ',', $IXAP370 ); } return $IXAP15; } public static function set_coupons_for_affiliate( $IXAP24, $IXAP370 = array() ) { global $affiliates_db; $IXAP24 = intval( $IXAP24 ); $IXAP379 = array(); foreach( $IXAP370 as $IXAP371 ) { $IXAP371 = trim( $IXAP371 ); if ( strlen( $IXAP371 ) > 0 ) { $IXAP372 = self::get_affiliate_for_coupon( $IXAP371 ); if ( ( $IXAP372 === null ) || ( $IXAP372 == $IXAP24 ) ) { $IXAP379[] = $IXAP371; } } } $IXAP370 = $IXAP379; $IXAP380 = self::get_coupons_for_affiliate( $IXAP24 ); if ( $IXAP380 != $IXAP370 ) { $IXAP25 = $affiliates_db->get_tablename( 'affiliates_attributes' ); if ( count( $IXAP370 ) == 0 ) { if ( $affiliates_db->query( "DELETE FROM $IXAP25 WHERE affiliate_id=%d AND attr_key=%s", $IXAP24, $IXAP356 ) ) { do_action( 'affiliates_removed_attribute', $IXAP24, Affiliates_Attributes::IXAP86, implode( ',', $IXAP380 ) ); } } else { if ( $IXAP374 = $affiliates_db->get_value( "SELECT attr_value FROM $IXAP25 WHERE affiliate_id = %d AND attr_key = %s", $IXAP24, Affiliates_Attributes::IXAP86 ) ) { if ( $affiliates_db->query( "UPDATE $IXAP25 SET attr_value=%s WHERE affiliate_id=%d AND attr_key=%s", implode( ',', $IXAP370 ) , $IXAP24, Affiliates_Attributes::IXAP86 ) ) { do_action( 'affiliates_updated_attribute', $IXAP24, Affiliates_Attributes::IXAP86, $IXAP374, implode( ',', $IXAP370 ) ); } } else { if ( $affiliates_db->query( "INSERT INTO $IXAP25 SET affiliate_id=%d, attr_key=%s, attr_value=%s", $IXAP24, Affiliates_Attributes::IXAP86, implode( ',', $IXAP370 ) ) ) { do_action( 'affiliates_added_attribute', $IXAP24, Affiliates_Attributes::IXAP86, implode( ',', $IXAP370 ) ); } } } } } } 